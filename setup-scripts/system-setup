#!/usr/bin/env zsh

set -e # Exit on any command failure

# ~~~~~~~~~~~~~~~ Load helper functions ~~~~~~~~~~~~~~~

source "$SCRIPT_FNS/log.zsh"

# ~~~~~~~~~~~~~~ Ensure ZSH is the default shell ~~~~~~~~~~~~~~~

local ZSH_PATH=$(which zsh)
if [[ "$SHELL" == "$ZSH_PATH" ]]; then
    log "ZSH is already the default shell. Skipping..."
else
    log "Setting up ZSH as default shell."
    chsh -s "$ZSH_PATH"
fi

# ~~~~~~~~~~~~~~ Ensure that zinit is installed ~~~~~~~~~~~~~~~

local ZINIT_HOME="${ZINIT_HOME:-$HOME/.local/share}/zinit/zinit.git"
if [ ! -d $ZINIT_HOME ]; then
    log "Zinit not found. Cloning into $ZINIT_HOME..."
    mkdir -p "$(dirname $ZINIT_HOME)"
    git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
    log "Zinit cloned successfully."
fi

# ~~~~~~~~~~~~~~ Ensure that cargo is installed ~~~~~~~~~~~~~~~

if command -v cargo > /dev/null 2>&1; then
    log "Rust SDK is already installed. Skipping installation."
else
    log "Installing Rust SDK."
    curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
fi

# ~~~~~~~~~~~~~~ Paru packages installation  ~~~~~~~~~~~~~~~

paru -S --noconfirm --needed \
    7zip \
    atool \
    bat \
    bfs \
    binutils \
    catdoc \
    clipse-bin \
    dbus \
    docx2txt \
    doublecmd \
    fd \
    ffmpeg \
    ffmpegthumbnailer \
    fzf \
    gdk-pixbuf2 \
    ghostty \
    gnumeric \
    hyprpicker \
    imagemagick \
    inter-font \
    jq \
    jujutsu \
    kitty \
    libcdio \
    libqalculate \
    librsvg \
    mediainfo \
    odt2txt \
    openssl \
    p7zip \
    perl-image-exiftool \
    poppler \
    qt6ct \
    resvg \
    ripgrep \
    sherlock-launcher-bin \
    ttf-firacode-nerd \
    wl-clipboard \
    yazi-nightly-bin

# ~~~~~~~~~~~~~~ Cargo packages installation ~~~~~~~~~~~~~~~

cargo install \
    eza \
    zoxide \
    starship

# ~~~~~~~~~~~~~~ Install Bun ~~~~~~~~~~~~~~~

# Run bun install script if bun is not installed

if command -v bun > /dev/null 2>&1; then
    log "Bun is already installed. Checking for updates..."
    bun upgrade
else
    log "Installing Bun."
    curl -fsSL https://bun.sh/install | bash
fi

# ~~~~~~~~~~~~~~ Generate completions ~~~~~~~~~~~~~~~

# ~~~~~~~~~~~~~~ Enable systemctl services ~~~~~~~~~~~~~~~
