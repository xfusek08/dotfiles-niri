#!/usr/bin/env zsh

source "$SCRIPT_FNS/log.zsh"

function _main() {
    # prepare directories
    # -------------------

    local main_directory="$HOME/.tagstudio"
    local install_directory="$main_directory/app"

    # Remove installation directory
    # -----------------------------

    if [ -d "$install_directory" ]; then
        log -f "Removing TagStudio installation directory"
        rm -rf "$install_directory"
    fi

    # Remove symbolic link
    # ---------------------

    if [ -L "$HOME/.local/bin/tagstudio" ]; then
        log -f "Removing TagStudio executable link"
        rm -f "$HOME/.local/bin/tagstudio"
    fi

    # Remove desktop entry
    # --------------------

    if [ -f "$HOME/.local/share/applications/tagstudio.desktop" ]; then
        log -f "Removing TagStudio desktop entry"
        rm -f "$HOME/.local/share/applications/tagstudio.desktop"
    fi

    # Optionally remove icon cache entry (best-effort, desktop environments vary)
    update-desktop-database "$HOME/.local/share/applications" >/dev/null 2>&1 || true

    # Remove cache directories
    # ------------------------

    for cache_dir in "$HOME/.cache/TagStudio" "$HOME/.cache/tagstudio"; do
        if [ -d "$cache_dir" ]; then
            log -f "Removing TagStudio cache directory: $cache_dir"
            rm -rf "$cache_dir"
        fi
    done

    # Clean up main directory if empty
    # --------------------------------

    if [ -d "$main_directory" ] && [ -z "$(ls -A "$main_directory")" ]; then
        log -f "Removing empty TagStudio configuration directory"
        rm -rf "$main_directory"
    fi

    log -f "TagStudio uninstallation completed"
}

_main "$@"
exit $?
